{% extends 'pages/base.html' %}
{% load static %}

{% block content %}
<main class="page_content">
  <section class="blog_section mt-3 mb-5">
    <div class="container">

      <div class="card shadow-lg border-0 rounded-4">
        <div class="card-body p-4">
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
            <div>
              <h3 class="fw-bold mb-1">
                <span class="ru_text">Календарь программ</span>
                <span class="uz_text">Dasturlar taqvimi</span>
                <span class="en_text">Programs calendar</span>
              </h3>
              <small class="text-secondary">
                <span class="ru_text">Выберите год и месяц, чтобы посмотреть программы.</span>
                <span class="uz_text">Dasturlarni ko'rish uchun yil va oyni tanlang.</span>
                <span class="en_text">Choose year and month to view programs.</span>
              </small>
            </div>

            <form class="form-inline" method="get" id="calendarFilters">
              <div class="row g-2 align-items-center">
                <div class="col-auto">
                  <select name="year" class="form-select form-select-sm shadow-sm" onchange="document.getElementById('calendarFilters').submit()">
                    {% for y in years %}
                      <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-auto">
                  <select name="month" class="form-select form-select-sm shadow-sm" onchange="document.getElementById('calendarFilters').submit()">
                    <option value="1" {% if month == 1 %}selected{% endif %}>Январь</option>
                    <option value="2" {% if month == 2 %}selected{% endif %}>Февраль</option>
                    <option value="3" {% if month == 3 %}selected{% endif %}>Март</option>
                    <option value="4" {% if month == 4 %}selected{% endif %}>Апрель</option>
                    <option value="5" {% if month == 5 %}selected{% endif %}>Май</option>
                    <option value="6" {% if month == 6 %}selected{% endif %}>Июнь</option>
                    <option value="7" {% if month == 7 %}selected{% endif %}>Июль</option>
                    <option value="8" {% if month == 8 %}selected{% endif %}>Август</option>
                    <option value="9" {% if month == 9 %}selected{% endif %}>Сентябрь</option>
                    <option value="10" {% if month == 10 %}selected{% endif %}>Октябрь</option>
                    <option value="11" {% if month == 11 %}selected{% endif %}>Ноябрь</option>
                    <option value="12" {% if month == 12 %}selected{% endif %}>Декабрь</option>
                  </select>
                </div>
                <div class="col-auto">
                  <a class="btn btn-secondary" style="padding-top: 6px; padding-bottom: 6px; margin-right: 10px;" href="{% url 'programs_calendar' %}">
                    <span class="ru_text">Сбросить</span>
                    <span class="uz_text">Tozalash</span>
                    <span class="en_text">Reset</span>
                  </a>
                </div>
              </div>
            </form>
          </div>

          <!-- Calendar grid -->
          <div class="table-responsive rounded-3 overflow-hidden">
            <table class="table table-bordered text-center align-middle calendar-table mb-0">
              <thead class="table-light">
                <tr>
                  <th class="text-center">
                    <span class="ru_text">Пн</span>
                    <span class="uz_text">Du</span>
                    <span class="en_text">Mon</span>
                  </th>
                  <th class="text-center">
                    <span class="ru_text">Вт</span>
                    <span class="uz_text">Se</span>
                    <span class="en_text">Tue</span>
                  </th>
                  <th class="text-center">
                    <span class="ru_text">Ср</span>
                    <span class="uz_text">Chor</span>
                    <span class="en_text">Wed</span>
                  </th>
                  <th class="text-center">
                    <span class="ru_text">Чт</span>
                    <span class="uz_text">Pay</span>
                    <span class="en_text">Thu</span>
                  </th>
                  <th class="text-center">
                    <span class="ru_text">Пт</span>
                    <span class="uz_text">Ju</span>
                    <span class="en_text">Fri</span>
                  </th>
                  <th class="text-center text-primary">
                    <span class="ru_text">Сб</span>
                    <span class="uz_text">Sha</span>
                    <span class="en_text">Sat</span>
                  </th>
                  <th class="text-center text-danger">
                    <span class="ru_text">Вс</span>
                    <span class="uz_text">Yak</span>
                    <span class="en_text">Sun</span>
                  </th>
                </tr>
              </thead>
              <tbody>
                {% for week in weeks %}
                  <tr>
                    {% for day in week %}
                      {% if not day.in_month %}
                        <td class="disabled-day small">{{ day.day }}</td>
                      {% else %}
                        {% if day.programs %}
                          <td class="day-with-program position-relative"
                              data-iso="{{ day.iso }}"
                              onclick="openProgramsModal(this)">
                            <div class="fw-semibold mb-1">{{ day.day }}</div>
                            <span class="badge bg-primary rounded-pill position-absolute top-0 end-0 translate-middle mt-3">
                              {{ day.programs|length }}
                            </span>
                            <div class="program-title small text-truncate text-secondary">
                              <span class="uz_text">{{ day.programs.0.title_uz|truncatechars:18 }}</span>
                              <span class="ru_text">{{ day.programs.0.title_ru|truncatechars:18 }}</span>
                              <span class="en_text">{{ day.programs.0.title_en|truncatechars:18 }}</span>
                            </div>
                          </td>
                        {% else %}
                          <td onclick="openProgramsModal(this)" data-iso="{{ day.iso }}" class="hoverable-day small text-muted">
                            {{ day.day }}
                          </td>
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="mt-3 text-muted">
            <small>
              <span class="ru_text">Сегодня:</span>
              <span class="uz_text">Bugun:</span>
              <span class="en_text">Today:</span>
              {{ today|date:"d.m.Y" }}
            </small>
          </div>
        </div>
      </div>

    </div>
  </section>
</main>

<!-- Programs modal -->
<div class="modal fade" id="programsModal" tabindex="-1" aria-labelledby="programsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content rounded-5 shadow-lg">
      <div class="modal-header bg-primary rounded-top-4">
        <h5 class="modal-title mb-0">
          <!-- <span class="ru_text">Программы на</span>
          <span class="uz_text">Kunidagi dasturlar</span>
          <span class="en_text">Programs on</span> -->
          <span id="modalDateText" style="color: white;"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-3" id="programsModalBody"></div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding-top: 6px; padding-bottom: 6px;">
          <span class="ru_text">Закрыть</span>
          <span class="uz_text">Yopish</span>
          <span class="en_text">Close</span>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  /* Calendar look */
  .calendar-table th, .calendar-table td {
    width: 14.285%;
    min-width: 95px;
    height: 110px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  thead.table-light th {
    padding-top: 4px;        /* reduce top padding */
    padding-bottom: 4px;     /* reduce bottom padding */
    line-height: 1.1;        /* tighten text spacing */
    font-size: 0.9rem;       /* make slightly smaller if you want */
    vertical-align: middle;  /* align text vertically centered */
    height: 50px;
  }

  .calendar-table td:hover {
    background-color: #f1f8ff;
  }

  .day-with-program {
    background: #f9fcff;
    border-left: 4px solid #0d6efd;
  }

  .disabled-day {
    background: #f8f9fa;
    color: #c0c0c0;
  }

  .program-title {
    display: block;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    line-height: 1.2;
  }

  @media (max-width: 768px) {
    .calendar-table th, .calendar-table td {
      font-size: 0.85rem;
      min-width: 70px;
      height: 80px;
      padding: 4px;
    }
    .program-title {
      font-size: 0.75rem;
    }
  }

  .list-group-item {
    border: 1px solid #e5e7eb !important;
    border-radius: 0.75rem !important;
    margin-bottom: 8px;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .list-group-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
  }
</style>

<script>
  const programsByDate = JSON.parse(`{{ programs_json|escapejs }}`);

  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#039;');
  }

  function openProgramsModal(cell) {
    const iso = cell.dataset.iso;
    const modal = new bootstrap.Modal(document.getElementById('programsModal'));
    const modalBody = document.getElementById('programsModalBody');
    const modalDateText = document.getElementById('modalDateText');

    const dt = new Date(iso + 'T00:00:00');
    const parts = dt.toLocaleDateString('en-GB').split('/');
    const readable = `${parts[0]}.${parts[1]}.${parts[2]}`;
    modalDateText.textContent = ' ' + readable;

    modalBody.innerHTML = '';
    const items = programsByDate[iso] || [];

    if (items.length === 0) {
      modalBody.innerHTML = `
        <p class="text-muted text-center py-3">
          <span class="ru_text">Программ на эту дату нет.</span>
          <span class="uz_text">Bu kunda dastur yo'q.</span>
          <span class="en_text">No programs on this date.</span>
        </p>`;
    } else {
      const list = document.createElement('div');
      list.className = 'list-group';
      items.forEach(prog => {
        const a = document.createElement('a');
        a.className = 'list-group-item list-group-item-action';
        a.href = prog.url || '#';
        a.innerHTML = `
          <div class="d-flex w-100 justify-content-between">
            <h6 class="mb-1 fw-semibold">
              <span class="uz_text">${escapeHtml(prog.title_uz)}</span>
              <span class="ru_text">${escapeHtml(prog.title_ru)}</span>
              <span class="en_text">${escapeHtml(prog.title_en)}</span>
            </h6>
          </div>
          <p class="mb-1 text-muted small text-truncate">
            <span class="uz_text">${prog.snippet_uz}</span>
            <span class="ru_text">${prog.snippet_ru}</span>
            <span class="en_text">${prog.snippet_en}</span>
          </p>`;
        list.appendChild(a);
      });
      modalBody.appendChild(list);
    }

    modal.show();
    applyCurrentLanguage();
  }

  function applyCurrentLanguage() {
    const lang = localStorage.getItem('lang') || 'uz';
    ['ru_text', 'uz_text', 'en_text'].forEach(cls => {
      document.querySelectorAll('.' + cls).forEach(el => {
        el.style.display = (cls.startsWith(lang)) ? 'inline-block' : 'none';
      });
    });
  }
</script>
{% endblock %}
